name: Sync Main to Dev

# Se ejecuta despuÃ©s de push a main (generalmente despuÃ©s de merge de PRs)
on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  sync:
    name: Sync main â†’ dev
    runs-on: ubuntu-latest
    # Solo ejecutar si NO es un commit de sincronizaciÃ³n (evitar loops)
    if: "!contains(github.event.head_commit.message, 'chore: sync')"

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Verificar si dev existe
        id: check_dev
        run: |
          if git ls-remote --heads origin dev | grep -q dev; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ“ Rama dev existe"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Rama dev no existe, se crearÃ¡"
          fi

      - name: Crear rama dev si no existe
        if: steps.check_dev.outputs.exists == 'false'
        run: |
          git checkout -b dev
          git push -u origin dev
          echo "âœ“ Rama dev creada"

      - name: Verificar si hay commits en main que dev no tiene
        id: check_diff
        run: |
          git fetch origin dev

          # Contar commits en main que dev NO tiene
          COMMITS_AHEAD=$(git rev-list --count origin/dev..origin/main)

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "has_diff=false" >> $GITHUB_OUTPUT
            echo "âœ“ main y dev estÃ¡n sincronizados ($COMMITS_AHEAD commits)"
          else
            echo "has_diff=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  main tiene $COMMITS_AHEAD commits que dev no tiene"
            echo "Commits a sincronizar:"
            git log --oneline origin/dev..origin/main
          fi

      - name: Merge main to dev con manejo de conflictos
        if: steps.check_diff.outputs.has_diff == 'true'
        run: |
          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout dev y actualizar primero (minimizar conflictos)
          git checkout dev
          git pull origin dev

          echo "ðŸ”„ Intentando merge de main a dev..."

          # Intentar merge
          if git merge origin/main --no-ff -m "chore: sync main to dev

          SincronizaciÃ³n automÃ¡tica de main a dev despuÃ©s de cambios en main.

          ðŸ¤– Generated with GitHub Actions"; then
            # Merge exitoso
            git push origin dev
            echo "âœ… SincronizaciÃ³n exitosa: main â†’ dev"
          else
            # Merge fallÃ³ (conflictos)
            echo "âŒ ERROR: Conflictos detectados en merge main â†’ dev"
            echo "::error::Conflictos requieren resoluciÃ³n manual"
            echo "::error::Archivos en conflicto:"
            git status --short
            git merge --abort
            exit 1
          fi

      - name: Resumen
        if: always()
        run: |
          echo "# ðŸ”„ SincronizaciÃ³n Main â†’ Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Aspecto | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rama dev existe | ${{ steps.check_dev.outputs.exists }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Diferencias | ${{ steps.check_diff.outputs.has_diff }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_diff.outputs.has_diff }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Merge automÃ¡tico completado" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ dev se sincronizÃ³ con main correctamente" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… main y dev ya estÃ¡n sincronizados" >> $GITHUB_STEP_SUMMARY
          fi
